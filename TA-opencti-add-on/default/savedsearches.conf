[Update OpenCTI Marking Definition Lookup]
search = | inputlookup opencti_marking \
| append [ \
     search `opencti_index` sourcetype="opencti:marking-definition" (event="create" OR event="update") \
     | dedup id \
     | table _key id name type created definition_type sourcetype \
] \
| outputlookup append=true opencti_marking
description = Updates the opencti_marking lookup with new and updated marking definitions
schedule = */15 * * * *
enabled = 1
dispatch.earliest_time = -15m
dispatch.latest_time = now
cron_schedule = */15 * * * *
alert.suppress = 0
alert.track = 0
action.summary_index = 0

[Update OpenCTI Indicators Lookup]
search = search `opencti_index` sourcetype="opencti:indicator" (event="create" OR event="update" OR event="delete") earliest=-15m latest=now \
| eval delete_flag=if(event="delete", "true", null()) \
| table id, _key, created, created_at, created_by, created_by_ref, description, detection, indicator_types, input_name, lang, main_observable_type, markings, modified, name, object_marking_refs, pattern, pattern_type, revoked, score, spec_version, type, updated_at, valid_from, valid_until, value, delete_flag \
| append [ | inputlookup opencti_indicators ] \
| stats latest(*) as * by id \
| where isnull(delete_flag) \
| fields - delete_flag \
| outputlookup opencti_indicators
description = Updates the opencti_indicators lookup with new and updated indicators, while flagging deleted ones.
schedule = */5 * * * *
enabled = 1
dispatch.earliest_time = -15m
dispatch.latest_time = now
cron_schedule = */5 * * * *
alert.suppress = 0
alert.track = 0
action.summary_index = 0

[Update OpenCTI Lookup]
search = search `opencti_index` sourcetype="opencti:indicator" (event="create" OR event="update" OR event="delete") earliest=-15m latest=now \
| eval delete_flag=if(event="delete", "true", null()) \
| table id, _key, created, created_at, created_by, created_by_ref, description, detection, indicator_types, input_name, lang, main_observable_type, markings, modified, name, object_marking_refs, pattern, pattern_type, revoked, score, spec_version, type, updated_at, valid_from, valid_until, value, delete_flag \
| append [ | inputlookup opencti_lookup ] \
| stats latest(*) as * by id \
| where isnull(delete_flag) \
| fields - delete_flag \
| outputlookup opencti_lookup
description = Updates the opencti_lookup lookup with new and updated indicators, while flagging deleted ones.
schedule = */5 * * * *
enabled = 1
dispatch.earliest_time = -15m
dispatch.latest_time = now
cron_schedule = */5 * * * *
alert.suppress = 0
alert.track = 0
action.summary_index = 0

[Update OpenCTI Threat Intelligence]
search = search index=opencti_stream sourcetype="opencti:indicator" (event="create" OR event="update" OR event="delete") earliest=-15m latest=now \
| eval delete_flag=if(event="delete", "true", null()) \
| eval threat_key=id \
| eval threat_description=name \
| eval threat_type=case( \
    type=="ipv4-addr", "ip_intel", \
    type=="ipv6-addr", "ip_intel", \
    type=="domain-name", "domain_intel", \
    type=="url", "url_intel", \
    type=="file", "file_intel", \
    type=="email-addr", "email_intel", \
    1==1, "unknown") \
| eval threat_match_value=value \
| eval threat_group=created_by \
| eval threat_category=mvjoin(labels, ", ") \
| eval threat_first_seen=created \
| eval threat_last_seen=modified \
| eval threat_confidence=confidence \
| eval threat_weight=score \
| table threat_key, threat_match_value, threat_type, threat_description, threat_group, threat_category, threat_first_seen, threat_last_seen, threat_confidence, threat_weight, delete_flag \
| append [ | inputlookup opencti_threatintel ] \
| stats latest(*) as * by threat_key \
| where isnull(delete_flag) \
| fields - delete_flag \
| outputlookup opencti_threatintel
description = Converts OpenCTI indicators to Splunk ES Threat Intelligence format and stores them in the ES KV Store.
schedule = */5 * * * *
enabled = 1
dispatch.earliest_time = -15m
dispatch.latest_time = now
cron_schedule = */5 * * * *
